<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YellowPunk Terminal</title>

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#111;
    color:#f5d742;
}
.hidden{ display:none; }
.main{
    display:grid;
    grid-template-columns:2fr 1fr;
}
.products{
    padding:20px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:10px;
}
.product{
    background:#222;
    border:2px solid #f5d742;
    padding:15px;
    text-align:center;
    cursor:pointer;
    transition: 0.3s all;
}
.product:hover{
    box-shadow: 0 0 10px #f5d742;
}
.ticket{
    border-left:2px solid #f5d742;
    padding:20px;
}
button{
    margin:5px;
    padding:8px 12px;
    border:none;
    background:#f5d742;
    font-weight:bold;
    cursor:pointer;
    transition: 0.3s all;
}
button:hover{
    box-shadow: 0 0 10px #f5d742;
}
.admin-panel{
    padding:20px;
    border-top:2px solid #f5d742;
    background:#1a001f;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
<h2>Login Bartender</h2>
<input id="username" placeholder="Usuario"><br>
<input id="password" type="password" placeholder="Contrase√±a"><br>
<button onclick="login()">Entrar</button>
</div>

<!-- POS -->
<div id="posScreen" class="hidden">

<h2 id="welcome"></h2>

<div class="main">
<div id="products" class="products"></div>

<div class="ticket">
<h3>Ticket</h3>
<div id="ticketItems"></div>
<h3>Total: $<span id="total">0</span></h3>
<button onclick="resetCart()">Reset</button>
<button onclick="cobrar()">Cobrar</button>
<button onclick="toggleHistorial()">Historial</button>
<button onclick="promptAdminPass()">Admin</button>
<button onclick="logout()">Cerrar sesi√≥n</button>
</div>
</div>

<!-- HISTORIAL -->
<div id="historialPanel" class="hidden" style="padding:20px;border-top:2px solid #f5d742;">
<h3>Historial</h3>
<div id="historialContent"></div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="admin-panel hidden">

<h3>Panel Admin</h3>

<h4>Crear Bartender</h4>
<input id="newUser" placeholder="Usuario">
<input id="newPass" placeholder="Contrase√±a">
<button onclick="createBartender()">Crear</button>

<h4>Lista de Bartenders</h4>
<div id="bartenderList"></div>

<h4>Gestionar Productos</h4>
<input id="productName" placeholder="Nombre del producto">
<input id="productPrice" type="number" placeholder="Precio">
<button onclick="addProduct()">Agregar / Actualizar</button>
<div id="productList"></div>

</div>

<script>
// üîë USUARIOS (bartenders)
let users = JSON.parse(localStorage.getItem("users")) || [];
if(!Array.isArray(users)) users = [];

let currentUser = null;

// CONTRASE√ëA GENERAL DEL PANEL ADMIN
const ADMIN_PASSWORD = "yellowpunk2077";

// PRODUCTOS
let products = [
    {name:"Cerveza", price:5},
    {name:"Ron", price:8},
    {name:"Whisky", price:10}
];

// Cargar productos desde localStorage
let storedProducts = JSON.parse(localStorage.getItem("products"));
if(Array.isArray(storedProducts) && storedProducts.length>0){
    products = storedProducts;
} else {
    localStorage.setItem("products", JSON.stringify(products));
}

let cart = [];
let total = 0;

// VENTAS
let sales;
try {
    sales = JSON.parse(localStorage.getItem("sales")) || [];
    if(!Array.isArray(sales)) sales = [];
} catch {
    sales = [];
}

// üîπ Primer bartender autom√°tico
if(users.length===0){
    const u = prompt("No hay bartenders. Crea el primer usuario:");
    const p = prompt("Contrase√±a del primer bartender:");
    if(u && p){
        users.push({username:u.trim(), password:p.trim(), role:"bartender"});
        localStorage.setItem("users", JSON.stringify(users));
        alert("Primer bartender creado: "+u);
    } else {
        alert("Debes crear un bartender para continuar.");
        location.reload();
    }
}

// FUNCIONES
function saveUsers(){
    localStorage.setItem("users", JSON.stringify(users));
}
function saveProducts(){
    localStorage.setItem("products", JSON.stringify(products));
    renderProducts();
    renderProductList();
}

// LOGIN
function login(){
    const u = username.value.trim();
    const p = password.value.trim();

    const found = users.find(user=>user.username===u && user.password===p);
    if(found){
        currentUser = found;
        loginScreen.classList.add("hidden");
        posScreen.classList.remove("hidden");
        welcome.innerText = "Conectado: " + currentUser.username;
        renderProducts();
    } else {
        alert("Usuario o contrase√±a incorrectos");
    }
}

function logout(){
    location.reload();
}

// PRODUCTOS
function renderProducts(){
    const container = document.getElementById("products");
    container.innerHTML="";
    products.forEach(p=>{
        const div=document.createElement("div");
        div.className="product";
        div.innerText=p.name+" $"+p.price;
        div.onclick=()=>addToCart(p);
        container.appendChild(div);
    });
}

function addToCart(p){
    cart.push(p);
    total+=p.price;
    renderTicket();
}

function renderTicket(){
    ticketItems.innerHTML="";
    cart.forEach(item=>{
        ticketItems.innerHTML+=item.name+" - $"+item.price+"<br>";
    });
    document.getElementById("total").innerText=total;
}

function resetCart(){
    cart=[];
    total=0;
    renderTicket();
}

// COBRAR
function cobrar(){
    if(cart.length===0) return;

    const sale={
        ticket:sales.length+1,
        date:new Date().toLocaleString(),
        bartender:currentUser.username,
        items:[...cart],
        total:total
    };

    sales.push(sale);
    localStorage.setItem("sales", JSON.stringify(sales));

    sendToSheets(sale); // ‚úÖ Enviar a Google Sheets

    resetCart();
    alert("Venta guardada");
}

// HISTORIAL
function toggleHistorial(){
    historialPanel.classList.toggle("hidden");
    renderHistorial();
}

function renderHistorial(){
    historialContent.innerHTML="";
    if(sales.length===0){
        historialContent.innerText="Sin ventas";
        return;
    }
    sales.slice().reverse().forEach(sale=>{
        let html="<div style='border:1px solid #f5d742;padding:10px;margin-bottom:10px'>";
        html+="<strong>Ticket #"+sale.ticket+"</strong><br>";
        html+=sale.date+"<br>";
        html+="Bartender: "+sale.bartender+"<br><br>";
        sale.items.forEach(item=>{
            html+=item.name+" $"+item.price+"<br>";
        });
        html+="<hr>Total: $"+sale.total+"</div>";
        historialContent.innerHTML+=html;
    });
}

// PANEL ADMIN POR CONTRASE√ëA
function promptAdminPass(){
    const pass = prompt("Ingresa la contrase√±a del panel admin:");
    if(pass === ADMIN_PASSWORD){
        adminPanel.classList.remove("hidden");
        renderBartenders();
        renderAdminProducts();
    } else {
        alert("Contrase√±a incorrecta");
    }
}

// ADMIN BARTENDERS
function createBartender(){
    const u=newUser.value.trim();
    const p=newPass.value.trim();
    if(!u||!p) return alert("Completa los campos");
    if(users.find(user=>user.username===u)) return alert("Usuario ya existe");

    users.push({username:u,password:p,role:"bartender"});
    saveUsers();
    renderBartenders();
    newUser.value="";
    newPass.value="";
}

function renderBartenders(){
    bartenderList.innerHTML="";
    users.forEach(user=>{
        if(user.role==="bartender"){
            bartenderList.innerHTML+=`
            ${user.username}
            <button onclick="deleteBartender('${user.username}')">X</button>
            <br>`;
        }
    });
}

function deleteBartender(username){
    users=users.filter(user=>user.username!==username);
    saveUsers();
    renderBartenders();
}

// ADMIN PRODUCTOS
function addProduct(){
    const name = productName.value.trim();
    const price = parseFloat(productPrice.value);

    if(!name || isNaN(price) || price<0){
        alert("Nombre y precio v√°lidos son requeridos");
        return;
    }

    const existing = products.find(p=>p.name.toLowerCase()===name.toLowerCase());
    if(existing){
        existing.price = price;
    } else {
        products.push({name:name, price:price});
    }

    saveProducts();
    productName.value="";
    productPrice.value="";
}

function renderProductList(){
    const container = document.getElementById("productList");
    container.innerHTML="";
    products.forEach((p,i)=>{
        container.innerHTML+=`
        ${p.name} - $${p.price}
        <button onclick="deleteProduct(${i})">X</button><br>`;
    });
}

function deleteProduct(index){
    if(confirm("Eliminar producto "+products[index].name+"?")){
        products.splice(index,1);
        saveProducts();
    }
}

function renderAdminProducts(){
    renderProductList();
}

// üîπ Google Sheets
function sendToSheets(sale){
    const url = "https://script.google.com/macros/s/AKfycbwh3QQynxHgLv2XINajNUUBKnZw-Xv5KFdDcCAO4qLR6OIjfjA-t8XPgmMEzZMwFp5N/exec"; // Pega aqu√≠ la URL de tu Web App
    fetch(url, {
        method:"POST",
        body: JSON.stringify(sale)
    })
    .then(res=>res.json())
    .then(data=>console.log("Venta enviada a Sheets", data))
    .catch(err=>console.error("Error enviando a Sheets", err));
}

</script>

</body>
</html>