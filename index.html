<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YellowPunk Terminal</title>
<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#111;
    color:#f5d742;
}
.hidden{ display:none; }
.main{
    display:grid;
    grid-template-columns:2fr 1fr;
}
.products{
    padding:20px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:10px;
}
.product{
    background:#222;
    border:2px solid #f5d742;
    padding:15px;
    text-align:center;
    cursor:pointer;
    transition: 0.3s all;
}
.product:hover{
    box-shadow: 0 0 10px #f5d742;
}
.ticket{
    border-left:2px solid #f5d742;
    padding:20px;
}
button{
    margin:5px;
    padding:8px 12px;
    border:none;
    background:#f5d742;
    font-weight:bold;
    cursor:pointer;
    transition: 0.3s all;
}
button:hover{
    box-shadow: 0 0 10px #f5d742;
}
.admin-panel{
    padding:20px;
    border-top:2px solid #f5d742;
    background:#1a001f;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
<h2>Login Bartender</h2>
<input id="username" placeholder="Usuario"><br>
<input id="password" type="password" placeholder="Contraseña"><br>
<button onclick="login()">Entrar</button>
</div>

<!-- POS -->
<div id="posScreen" class="hidden">
<h2 id="welcome"></h2>
<div class="main">
<div id="products" class="products"></div>
<div class="ticket">
<h3>Ticket</h3>
<div id="ticketItems"></div>
<h3>Total: $<span id="total">0</span></h3>
<button onclick="resetCart()">Reset</button>
<button onclick="cobrar()">Cobrar</button>
<button onclick="toggleHistorial()">Historial</button>
<button onclick="promptAdminPass()">Admin</button>
<button onclick="logout()">Cerrar sesión</button>
</div>
</div>

<!-- HISTORIAL -->
<div id="historialPanel" class="hidden" style="padding:20px;border-top:2px solid #f5d742;">
<h3>Historial</h3>
<div id="historialContent"></div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="admin-panel hidden">
<h3>Panel Admin</h3>
<h4>Crear Bartender</h4>
<input id="newUser" placeholder="Usuario">
<input id="newPass" placeholder="Contraseña">
<button onclick="createBartender()">Crear</button>
<h4>Lista de Bartenders</h4>
<div id="bartenderList"></div>
<h4>Gestionar Productos</h4>
<input id="productName" placeholder="Nombre del producto">
<input id="productPrice" type="number" placeholder="Precio">
<button onclick="addProduct()">Agregar / Actualizar</button>
<div id="productList"></div>
</div>

<script>
// Usuarios y seguridad
let users = JSON.parse(localStorage.getItem("users")) || [];
if(!Array.isArray(users)) users = [];
let currentUser = null;
const ADMIN_PASSWORD = "yellowpunk2077";

// Productos
let products = JSON.parse(localStorage.getItem("products")) || [
    {name:"Cerveza", price:5},
    {name:"Ron", price:8},
    {name:"Whisky", price:10}
];
localStorage.setItem("products", JSON.stringify(products));

// Ventas
let sales;
try {
    sales = JSON.parse(localStorage.getItem("sales"));
    if(!Array.isArray(sales)) sales = [];
} catch(err) { sales = []; }

// Primer bartender automático
if(users.length===0){
    const u = prompt("No hay bartenders. Crea el primer usuario:");
    const p = prompt("Contraseña del primer bartender:");
    if(u && p){
        users.push({username:u.trim(), password:p.trim(), role:"bartender"});
        localStorage.setItem("users", JSON.stringify(users));
        alert("Primer bartender creado: "+u);
    } else { alert("Debes crear un bartender"); location.reload(); }
}

// Guardar
function saveUsers(){ localStorage.setItem("users", JSON.stringify(users)); }
function saveProducts(){ localStorage.setItem("products", JSON.stringify(products)); renderProducts(); renderProductList(); }

// Login
function login(){
    const u = username.value.trim();
    const p = password.value.trim();
    const found = users.find(user=>user.username===u && user.password===p);
    if(found){
        currentUser = found;
        loginScreen.classList.add("hidden");
        posScreen.classList.remove("hidden");
        welcome.innerText = "Conectado: " + currentUser.username;
        renderProducts();
    } else { alert("Usuario o contraseña incorrectos"); }
}

function logout(){ location.reload(); }

// Productos
function renderProducts(){
    const container = document.getElementById("products");
    container.innerHTML="";
    products.forEach(p=>{
        const div=document.createElement("div");
        div.className="product";
        div.innerText=p.name+" $"+p.price;
        div.onclick=()=>addToCart(p);
        container.appendChild(div);
    });
}
function addToCart(p){ cart.push(p); total+=p.price; renderTicket(); }
let cart=[]; let total=0;
function renderTicket(){
    ticketItems.innerHTML="";
    cart.forEach(item=>{ ticketItems.innerHTML+=item.name+" - $"+item.price+"<br>"; });
    document.getElementById("total").innerText=total;
}
function resetCart(){ cart=[]; total=0; renderTicket(); }

// Cobrar y enviar a Google Sheets
function cobrar(){
    if(cart.length===0) return;
    const sale={
        ticket:sales.length+1,
        date:new Date().toLocaleString(),
        bartender:currentUser.username,
        items:[...cart],
        total:total
    };
    sales.push(sale);
    localStorage.setItem("sales", JSON.stringify(sales));
    sendToSheets(sale); // ✅ Enviar a Sheets
    resetCart();
    alert("Venta guardada");
}

// Historial
function toggleHistorial(){ historialPanel.classList.toggle("hidden"); renderHistorial(); }
function renderHistorial(){
    historialContent.innerHTML="";
    if(!Array.isArray(sales) || sales.length===0){ historialContent.innerText="Sin ventas"; return; }
    sales.slice().reverse().forEach(sale=>{
        let html="<div style='border:1px solid #f5d742;padding:10px;margin-bottom:10px'>";
        html+="<strong>Ticket #"+sale.ticket+"</strong><br>";
        html+=sale.date+"<br>";
        html+="Bartender: "+sale.bartender+"<br><br>";
        sale.items.forEach(item=>{ html+=item.name+" $"+item.price+"<br>"; });
        html+="<hr>Total: $"+sale.total+"</div>";
        historialContent.innerHTML+=html;
    });
}

// Admin
function promptAdminPass(){
    const pass = prompt("Ingresa la contraseña del panel admin:");
    if(pass === ADMIN_PASSWORD){
        adminPanel.classList.remove("hidden");
        renderBartenders(); renderAdminProducts();
    } else { alert("Contraseña incorrecta"); }
}

// Bartenders
function createBartender(){
    const u=newUser.value.trim();
    const p=newPass.value.trim();
    if(!u||!p) return alert("Completa los campos");
    if(users.find(user=>user.username===u)) return alert("Usuario ya existe");
    users.push({username:u,password:p,role:"bartender"});
    saveUsers();
    renderBartenders();
    newUser.value=""; newPass.value="";
}
function renderBartenders(){
    bartenderList.innerHTML="";
    users.forEach(user=>{ if(user.role==="bartender"){
        bartenderList.innerHTML+=`${user.username} <button onclick="deleteBartender('${user.username}')">X</button><br>`;
    }});
}
function deleteBartender(username){ users=users.filter(u=>u.username!==username); saveUsers(); renderBartenders(); }

// Productos admin
function addProduct(){
    const name = productName.value.trim();
    const price = parseFloat(productPrice.value);
    if(!name || isNaN(price) || price<0){ alert("Nombre y precio válidos"); return; }
    const existing = products.find(p=>p.name.toLowerCase()===name.toLowerCase());
    if(existing){ existing.price=price; } else { products.push({name:name,price:price}); }
    saveProducts();
    productName.value=""; productPrice.value="";
}
function renderProductList(){
    productList.innerHTML="";
    products.forEach((p,i)=>{ productList.innerHTML+=`${p.name} - $${p.price} <button onclick="deleteProduct(${i})">X</button><br>`; });
}
function deleteProduct(i){ if(confirm("Eliminar "+products[i].name+"?")){ products.splice(i,1); saveProducts(); } }
function renderAdminProducts(){ renderProductList(); }

// Google Sheets
function sendToSheets(sale){
    const url = "https://script.google.com/macros/s/AKfycbx9uF7xSBwHUBfcCk1H94LwT52TyD9spKQj6KjQ4f6nSMEEaKlv1LeAb_jMjhd5tIvp/exec"; // Pega aquí la URL de tu Web App
    fetch(url,{
        method:"POST",
        body:JSON.stringify(sale),
        mode:"no-cors" // ✅ evita CORS, envía datos aunque no lea respuesta
    })
    .then(()=>console.log("Venta enviada a Sheets"))
    .catch(err=>console.error("Error enviando a Sheets", err));
}
</script>

</body>
</html>