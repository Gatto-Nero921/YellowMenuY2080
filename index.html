<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YellowPunk Terminal</title>
<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#111;
    color:#f5d742;
}
.hidden{ display:none; }
.main{
    display:grid;
    grid-template-columns:2fr 1fr;
}
.products{
    padding:20px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
    gap:10px;
}
.product{
    background:#222;
    border:2px solid #f5d742;
    padding:15px;
    text-align:center;
    cursor:pointer;
    transition: 0.3s;
}
.product:hover{
    box-shadow:0 0 10px #f5d742;
}
.ticket{
    border-left:2px solid #f5d742;
    padding:20px;
}
button{
    margin:5px;
    padding:8px 12px;
    border:none;
    background:#f5d742;
    font-weight:bold;
    cursor:pointer;
}
button:hover{
    box-shadow:0 0 10px #f5d742;
}
.admin-panel{
    padding:20px;
    border-top:2px solid #f5d742;
    background:#1a001f;
}
</style>
</head>
<body>

<div id="loginScreen">
<h2>Login Bartender</h2>
<input id="username" placeholder="Usuario"><br>
<input id="password" type="password" placeholder="Contraseña"><br>
<button onclick="login()">Entrar</button>
</div>

<div id="posScreen" class="hidden">
<h2 id="welcome"></h2>
<div class="main">
<div id="products" class="products"></div>

<div class="ticket">
<h3>Ticket</h3>
<div id="ticketItems"></div>
<h3>Total: $<span id="total">0</span></h3>
<button onclick="resetCart()">Reset</button>
<button onclick="cobrar()">Cobrar</button>
<button onclick="toggleHistorial()">Historial</button>
<button onclick="promptAdminPass()">Admin</button>
<button onclick="logout()">Cerrar sesión</button>
</div>
</div>

<div id="historialPanel" class="hidden" style="padding:20px;border-top:2px solid #f5d742;">
<h3>Historial</h3>
<div id="historialContent"></div>
</div>

<div id="adminPanel" class="admin-panel hidden">
<h3>Panel Admin</h3>

<h4>Crear Bartender</h4>
<input id="newUser" placeholder="Usuario">
<input id="newPass" placeholder="Contraseña">
<button onclick="createBartender()">Crear</button>

<h4>Lista de Bartenders</h4>
<div id="bartenderList"></div>

<h4>Gestionar Productos</h4>
<input id="productName" placeholder="Nombre">
<input id="productPrice" type="number" placeholder="Precio">
<button onclick="addProduct()">Agregar / Actualizar</button>
<div id="productList"></div>
</div>

<script>

// ---------- USUARIOS ----------
let users = JSON.parse(localStorage.getItem("users"));
if(!Array.isArray(users)) users = [];
let currentUser = null;
const ADMIN_PASSWORD = "yellowpunk2077";

if(users.length === 0){
    const u = prompt("Crea el primer bartender:");
    const p = prompt("Contraseña:");
    if(u && p){
        users.push({username:u.trim(), password:p.trim(), role:"bartender"});
        localStorage.setItem("users", JSON.stringify(users));
        alert("Bartender creado");
    } else {
        alert("Debes crear un usuario");
        location.reload();
    }
}

// ---------- PRODUCTOS ----------
let defaultProducts = [
    {name:"Cerveza", price:8},
    {name:"Ron", price:8},
    {name:"Whisky", price:10},
    {name:"Ara-suck-a", price:36},
    {name:"Rompe relic", price:30},
    {name:"Ciber espacio", price:24},
    {name:"Hermandad Nómada", price:36},
    {name:"Abre heridas", price:36},
    {name:"Trueno Negro", price:24},
    {name:"Hamburguesa Yellow", price:24},
    {name:"Hamburguesa vegetariana", price:24},
    {name:"Pizza suprema", price:18},
    {name:"Papas Yellow", price:24},
    {name:"Pollo YFC", price:24}
];

let products = JSON.parse(localStorage.getItem("products"));
if(!Array.isArray(products)) products = [];

defaultProducts.forEach(p=>{
    if(!products.find(prod=>prod.name===p.name)){
        products.push(p);
    }
});

// Actualiza precio cerveza si ya existe
let cerveza = products.find(p=>p.name==="Cerveza");
if(cerveza) cerveza.price = 8;

localStorage.setItem("products", JSON.stringify(products));

// ---------- VENTAS ----------
let sales = JSON.parse(localStorage.getItem("sales"));
if(!Array.isArray(sales)) sales = [];

let ticketCounter = parseInt(localStorage.getItem("ticketCounter"));
if(isNaN(ticketCounter)) ticketCounter = 1;

// ---------- FUNCIONES ----------
function login(){
    const u = username.value.trim();
    const p = password.value.trim();
    const found = users.find(user=>user.username===u && user.password===p);
    if(found){
        currentUser = found;
        loginScreen.classList.add("hidden");
        posScreen.classList.remove("hidden");
        welcome.innerText = "Conectado: " + currentUser.username;
        renderProducts();
    } else alert("Credenciales incorrectas");
}

function logout(){ location.reload(); }

// Productos
let cart=[]; let total=0;

function renderProducts(){
    products.sort((a,b)=>a.name.localeCompare(b.name));
    products.forEach(p=>{
        const div=document.createElement("div");
        div.className="product";
        div.innerText=p.name+" $"+p.price;
        div.onclick=()=>addToCart(p);
        productsContainer.appendChild(div);
    });
}

const productsContainer = document.getElementById("products");

function addToCart(p){
    cart.push(p);
    total+=p.price;
    renderTicket();
}

function renderTicket(){
    ticketItems.innerHTML="";
    cart.forEach(item=>{
        ticketItems.innerHTML+=item.name+" - $"+item.price+"<br>";
    });
    totalDisplay.innerText=total;
}

const ticketItems=document.getElementById("ticketItems");
const totalDisplay=document.getElementById("total");

function resetCart(){
    cart=[]; total=0; renderTicket();
}

function cobrar(){
    if(cart.length===0) return;

    const sale={
        ticket:ticketCounter,
        date:new Date().toLocaleString(),
        bartender:currentUser.username,
        items:[...cart],
        total:total
    };

    sales.push(sale);
    localStorage.setItem("sales", JSON.stringify(sales));

    sendToSheets(sale);

    ticketCounter++;
    localStorage.setItem("ticketCounter", ticketCounter);

    resetCart();
    alert("Venta guardada");
}

function toggleHistorial(){
    historialPanel.classList.toggle("hidden");
    renderHistorial();
}

function renderHistorial(){
    historialContent.innerHTML="";
    if(!Array.isArray(sales)||sales.length===0){
        historialContent.innerText="Sin ventas";
        return;
    }

    sales.slice().reverse().forEach(sale=>{
        let html="<div style='border:1px solid #f5d742;padding:10px;margin-bottom:10px'>";
        html+="<strong>Ticket #"+sale.ticket+"</strong><br>";
        html+=sale.date+"<br>";
        html+="Bartender: "+sale.bartender+"<br><br>";
        sale.items.forEach(item=>{
            html+=item.name+" $"+item.price+"<br>";
        });
        html+="<hr>Total: $"+sale.total+"</div>";
        historialContent.innerHTML+=html;
    });
}

function promptAdminPass(){
    const pass = prompt("Contraseña admin:");
    if(pass===ADMIN_PASSWORD){
        adminPanel.classList.remove("hidden");
        renderBartenders();
        renderProductList();
    } else alert("Incorrecto");
}

// Google Sheets
function sendToSheets(sale){
    const url="https://script.google.com/macros/s/AKfycbx603Jf0VTPKRLJRCovmatxx-6T3kazgZtAwg-LAdTPoCDPnJf28Pc8v45-jSrAT2n1/exec";
    fetch(url,{
        method:"POST",
        body:JSON.stringify(sale),
        mode:"no-cors"
    }).then(()=>console.log("Venta enviada a Sheets"));
}

</script>
</body>
</html>